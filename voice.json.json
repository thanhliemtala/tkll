{"mode":"block","xmlText":"<xml xmlns=\"https://developers.google.com/blockly/xml\"><block type=\"ai_event_forever\" id=\"476+L,b7`_XJF_cC5H%/\" x=\"-537\" y=\"-562\"><statement name=\"ONSTART\"><block type=\"ai_mqtt_connect_default_servers\" id=\"aUFCKw:+V?WRwPvGkM=,\" disabled=\"true\"><field name=\"SERVER\">mqtt.ohstem.vn:8084</field><value name=\"USERNAME\"><shadow type=\"text\" id=\"*~vQRQsYTVg#Lh1Nvz1.\"><field name=\"TEXT\">Test 231 tkll</field></shadow></value><value name=\"KEY\"><shadow type=\"text\" id=\"9)^egk$mUmL9Q2wS7/rc\"><field name=\"TEXT\"></field></shadow></value><next><block type=\"ai_mqtt_connect_default_servers\" id=\"8W^+NYF99UOheudYr1(j\"><field name=\"SERVER\">io.adafruit.com:443</field><value name=\"USERNAME\"><shadow type=\"text\" id=\"V=jQe{,Q1h*IntZ;)Oh6\"><field name=\"TEXT\">thanhliemtala</field></shadow></value><value name=\"KEY\"><shadow type=\"text\" id=\"hn5weTWP:{FoK.,B6ZNl\"><field name=\"TEXT\">aio_gyUv68VsDq0FC34RFu99SsYdcfEz</field></shadow></value><next><block type=\"ai_speech_rec_event\" id=\"VXjG:l8pbM?fzTT94-K6\"><field name=\"language\">en-US</field><statement name=\"event_handler\"><block type=\"ai_speech_speak\" id=\"[$rgy01^V,qqS~*U[OrS\"><value name=\"TEXT\"><shadow type=\"text\" id=\"T1u25^eUN_MRTB#koN4e\"><field name=\"TEXT\">Hello</field></shadow></value><next><block type=\"ai_display_background\" id=\"_V/k,j%]o:0#~=20,88=\"><value name=\"COLOR\"><shadow type=\"colour_picker\" id=\"f[2xt8mmgYmOVB{m#qa-\"><field name=\"COLOUR\">#ffff00</field></shadow></value><next><block type=\"ai_display_text\" id=\"ti^{{R^yHP[DyOQ6ve=S\"><value name=\"TEXT\"><shadow type=\"text\" id=\"-WWA#pO#tFD99mDlW^KL\"><field name=\"TEXT\">Hello</field></shadow><block type=\"ai_speech_rec_result\" id=\"W3FI6I!|MT{i9pad3eOc\"></block></value><value name=\"X\"><shadow type=\"math_number\" id=\"f6zM0my/5RtS6z^~H;A{\"><field name=\"NUM\">25</field></shadow></value><value name=\"Y\"><shadow type=\"math_number\" id=\"4Vh;[GN}j*gBl,-Fv4HC\"><field name=\"NUM\">25</field></shadow></value><next><block type=\"controls_if\" id=\"bM84H+6*%/7k=4aDuxw.\"><value name=\"IF0\"><block type=\"logic_operation\" id=\"fFeE}~gL3vBViE[D?@nv\"><field name=\"OP\">AND</field><value name=\"A\"><block type=\"ai_speech_rec_result_check\" id=\"{/gB$]kx3sJ7SBf:d+p@\"><value name=\"check_values\"><shadow type=\"text\" id=\"Rrh-YX!^TY0Df`D_{w4*\"><field name=\"TEXT\">on</field></shadow></value></block></value><value name=\"B\"><block type=\"ai_speech_rec_result_check\" id=\"rl9S+*AUA:`fSUEel#MW\"><value name=\"check_values\"><shadow type=\"text\" id=\"08y!s.=LlGXTatZ)Mw6Z\"><field name=\"TEXT\">light</field></shadow></value></block></value></block></value><statement name=\"DO0\"><block type=\"ai_mqtt_publish\" id=\"dnpMmL2n},JARNeQN(%V\"><value name=\"MESSAGE\"><shadow type=\"text\" id=\"(r//BD=/{{Q-1xJ8wqQy\"><field name=\"TEXT\">1</field></shadow></value><value name=\"TOPIC\"><shadow type=\"text\" id=\"XDW[y^Ma`0!sC:l6PW._\"><field name=\"TEXT\">button1</field></shadow></value></block></statement><next><block type=\"controls_if\" id=\"bZI]Uve]#qsbJ9P+~LZV\"><value name=\"IF0\"><block type=\"logic_operation\" id=\"qK6=|He)lABu}l5ej?`n\"><field name=\"OP\">AND</field><value name=\"A\"><block type=\"ai_speech_rec_result_check\" id=\"MFyD]9.A,p}R6*m5%R#Z\"><value name=\"check_values\"><shadow type=\"text\" id=\"/-3!F9J%$xH.*EKc66@n\"><field name=\"TEXT\">off</field></shadow></value></block></value><value name=\"B\"><block type=\"ai_speech_rec_result_check\" id=\"k.bwFOa3l9VM}S*@P%L!\"><value name=\"check_values\"><shadow type=\"text\" id=\"M{9!~3br63FK]HHEp?^C\"><field name=\"TEXT\">light</field></shadow></value></block></value></block></value><statement name=\"DO0\"><block type=\"ai_mqtt_publish\" id=\"p;%-u~.)6+Sqe6Yi97.i\"><value name=\"MESSAGE\"><shadow type=\"text\" id=\"lFcvekTo(v`=Vpy3gQ%R\"><field name=\"TEXT\">0</field></shadow></value><value name=\"TOPIC\"><shadow type=\"text\" id=\"4Mekgj$mCoBsKQL9{Z8{\"><field name=\"TEXT\">button1</field></shadow></value></block></statement><next><block type=\"controls_if\" id=\";%nlNHueV/fudhqmHSiC\"><value name=\"IF0\"><block type=\"logic_operation\" id=\"C$4Hd^LpZAKD]A!o,+Be\"><field name=\"OP\">AND</field><value name=\"A\"><block type=\"ai_speech_rec_result_check\" id=\"13pfG?,^2;=N/r/k*.In\"><value name=\"check_values\"><shadow type=\"text\" id=\"50JN`Iov~T}[Y4u+[3sB\"><field name=\"TEXT\">fan</field></shadow></value></block></value><value name=\"B\"><block type=\"ai_speech_rec_result_check\" id=\"yLq%BqI.r9NhnqjMb@`h\"><value name=\"check_values\"><shadow type=\"text\" id=\"z~zFBd5MNmp}Hf(l/i7(\"><field name=\"TEXT\">light</field></shadow></value></block></value></block></value><statement name=\"DO0\"><block type=\"ai_mqtt_publish\" id=\"u+g*E}^tBnxWDT,Yc|{:\"><value name=\"MESSAGE\"><shadow type=\"text\" id=\"`ZaHi.0K(^4|H@SE(9+k\"><field name=\"TEXT\">1</field></shadow></value><value name=\"TOPIC\"><shadow type=\"text\" id=\"v-`l4KAv-$sqEtjJw)bl\"><field name=\"TEXT\">button2</field></shadow></value></block></statement><next><block type=\"controls_if\" id=\"_yMTOZ.irMQW.*$4BHZn\"><value name=\"IF0\"><block type=\"logic_operation\" id=\"-?PN+7zFyh,FJ*tM1_x%\"><field name=\"OP\">AND</field><value name=\"A\"><block type=\"ai_speech_rec_result_check\" id=\"}8,Iot5{!eRGBbb5pr^M\"><value name=\"check_values\"><shadow type=\"text\" id=\"8n[+py/BVbB}r6O+}Rev\"><field name=\"TEXT\">fan</field></shadow></value></block></value><value name=\"B\"><block type=\"ai_speech_rec_result_check\" id=\"$WRIimtPQw#v`(bDn*mB\"><value name=\"check_values\"><shadow type=\"text\" id=\"n~Vq}B%*`t0#9uVmI%v~\"><field name=\"TEXT\">medium</field></shadow></value></block></value></block></value><statement name=\"DO0\"><block type=\"ai_mqtt_publish\" id=\"E,l).de5[)PS[k78VI*K\"><value name=\"MESSAGE\"><shadow type=\"text\" id=\"$kh*gq~w#;M4:b=wJtyy\"><field name=\"TEXT\">2</field></shadow></value><value name=\"TOPIC\"><shadow type=\"text\" id=\")nc?W6-fOgiEN.#krv;_\"><field name=\"TEXT\">button2</field></shadow></value></block></statement><next><block type=\"controls_if\" id=\"hkU-o:uJeR24}g03hL.f\"><value name=\"IF0\"><block type=\"logic_operation\" id=\"!uI?32qw0LUxjoo)G@0-\"><field name=\"OP\">AND</field><value name=\"A\"><block type=\"ai_speech_rec_result_check\" id=\"eN;61mA%ha[TfD++QJ?h\"><value name=\"check_values\"><shadow type=\"text\" id=\"5I%~b^oRqENe_FivUbK~\"><field name=\"TEXT\">fan</field></shadow></value></block></value><value name=\"B\"><block type=\"ai_speech_rec_result_check\" id=\"LtU:*QovSn+8UzfGrCw7\"><value name=\"check_values\"><shadow type=\"text\" id=\"hcDL{}QUboLcqoyYr8-s\"><field name=\"TEXT\">high</field></shadow></value></block></value></block></value><statement name=\"DO0\"><block type=\"ai_mqtt_publish\" id=\"PW3dZLbW*H=%c@ZlF`#2\"><value name=\"MESSAGE\"><shadow type=\"text\" id=\"=FCj6q3xr{`S}})]$:Nc\"><field name=\"TEXT\">3</field></shadow></value><value name=\"TOPIC\"><shadow type=\"text\" id=\"}E|fp/tG*rx[(pZ=H+Q^\"><field name=\"TEXT\">button2</field></shadow></value></block></statement><next><block type=\"controls_if\" id=\";|=f+Q*c.9Li7vgeH*Re\"><value name=\"IF0\"><block type=\"logic_operation\" id=\"64i]FCSHW?w0rSR9=+#3\"><field name=\"OP\">AND</field><value name=\"A\"><block type=\"ai_speech_rec_result_check\" id=\"DXc*+g6[c~vkjwZ/g:yI\"><value name=\"check_values\"><shadow type=\"text\" id=\"33bvh5#l=/?$vK7i,o|y\"><field name=\"TEXT\">fan</field></shadow></value></block></value><value name=\"B\"><block type=\"ai_speech_rec_result_check\" id=\"tDD=MwDck22%vYl_u?VF\"><value name=\"check_values\"><shadow type=\"text\" id=\"(l#3pgpC5OpRPbv=6?I0\"><field name=\"TEXT\">off</field></shadow></value></block></value></block></value><statement name=\"DO0\"><block type=\"ai_mqtt_publish\" id=\"Q@0Fhxphn.(PN]q[/Gdr\"><value name=\"MESSAGE\"><shadow type=\"text\" id=\"-7SM19s*`GI^|s$m-xyG\"><field name=\"TEXT\">0</field></shadow></value><value name=\"TOPIC\"><shadow type=\"text\" id=\"Q|c7TH!i^s2PvkB7YsP,\"><field name=\"TEXT\">button2</field></shadow></value></block></statement></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></next></block></statement><next><block type=\"ai_speech_rec_event_mode\" id=\"=^ljtH;m3h*Arg3|*A1n\"><field name=\"mode\">false</field></block></next></block></next></block></next></block></statement></block><block type=\"controls_if\" id=\"`6nMHm*6,4%25X5Nr[9_\" x=\"-788\" y=\"-463\"></block><block type=\"ai_ml_sound_classify_event\" id=\"[R.UAW`}p{g)N0ow2lt?\" x=\"-1062\" y=\"-187\"><field name=\"model\"></field></block></xml>","javascript":"function mqtt_check_connection() {\n  client.on(\"connect\", function () {\n    console.log(\"Connected\")\n  })\n}\n\nfunction mqtt_check_message() {\n  client.on(\"message\", (topic, message, packet) => {\n    console.log(\"Received Message: \" + message.toString() + \" on topic: \" + topic)\n  })\n}\n\nfunction mqtt_subscribe(topic) {\n  client.subscribe(options.username + /feeds/ + topic, { qos: 0 }, function (error, granted) {\n    if (error) {\n      console.log(error)\n    } else {\n      console.log(`${granted[0].topic} was subscribed`)\n    }\n  })\n}\n\nfunction mqtt_publish(topic, msg) {\n  client.publish(options.username + /feeds/ + topic, msg, { qos: 0, retain: false }, function (error) {\n    if (error) {\n      console.log(error)\n    } else {\n      console.log(\"Published\")\n    }\n  })\n}\n\nfunction p5speechRecGotResult() {\n  p5Speech.speak('Hello');\n  background('#ffff00');\n  text((p5SpeechRec.resultString.toLowerCase()) , 25, 25);\n  if (new RegExp('on'.split(\",\").map(function(item) {return item.trim();}).join(\"|\")).test(p5SpeechRec.resultString.toLowerCase()) && new RegExp('light'.split(\",\").map(function(item) {return item.trim();}).join(\"|\")).test(p5SpeechRec.resultString.toLowerCase())) {\n    mqtt_publish('button1', '1')\n  }\n  if (new RegExp('off'.split(\",\").map(function(item) {return item.trim();}).join(\"|\")).test(p5SpeechRec.resultString.toLowerCase()) && new RegExp('light'.split(\",\").map(function(item) {return item.trim();}).join(\"|\")).test(p5SpeechRec.resultString.toLowerCase())) {\n    mqtt_publish('button1', '0')\n  }\n  if (new RegExp('fan'.split(\",\").map(function(item) {return item.trim();}).join(\"|\")).test(p5SpeechRec.resultString.toLowerCase()) && new RegExp('light'.split(\",\").map(function(item) {return item.trim();}).join(\"|\")).test(p5SpeechRec.resultString.toLowerCase())) {\n    mqtt_publish('button2', '1')\n  }\n  if (new RegExp('fan'.split(\",\").map(function(item) {return item.trim();}).join(\"|\")).test(p5SpeechRec.resultString.toLowerCase()) && new RegExp('medium'.split(\",\").map(function(item) {return item.trim();}).join(\"|\")).test(p5SpeechRec.resultString.toLowerCase())) {\n    mqtt_publish('button2', '2')\n  }\n  if (new RegExp('fan'.split(\",\").map(function(item) {return item.trim();}).join(\"|\")).test(p5SpeechRec.resultString.toLowerCase()) && new RegExp('high'.split(\",\").map(function(item) {return item.trim();}).join(\"|\")).test(p5SpeechRec.resultString.toLowerCase())) {\n    mqtt_publish('button2', '3')\n  }\n  if (new RegExp('fan'.split(\",\").map(function(item) {return item.trim();}).join(\"|\")).test(p5SpeechRec.resultString.toLowerCase()) && new RegExp('off'.split(\",\").map(function(item) {return item.trim();}).join(\"|\")).test(p5SpeechRec.resultString.toLowerCase())) {\n    mqtt_publish('button2', '0')\n  }\n\n}\n\nfunction p5speechRecOnEnd() {\n  p5SpeechRec.start();\n}\n\nfunction sleep(s) {\n  ms = s * 1000\n  return new Promise(resolve => setTimeout(resolve, ms));\n}\n\nfunction loadAIModel(fromLocal, URI, modelType) { // modelType = 0:image, 1:audio, 2:pose\n  if (fromLocal) {\n    if (modelType == 0) {  // video classification model\n      const projects = JSON.parse(window.localStorage.getItem(\"ohstemai_projects\"));\n      let project;\n      if (projects && projects.data && Boolean(projects.data)) {\n        project = projects.data[URI];\n      }\n\n      parent.tf.loadLayersModel(\"indexeddb://\" + project.id).then((layersModel) => {\n        tmModel = new parent.tm.CustomMobileNet(layersModel, project.metadata);\n      }).catch((err) => console.log(err));\n    } else if (modelType == 1) {  // sound classification model\n      // Load the model first\n      const baseRecognizer = parent.spc.create(\"BROWSER_FFT\");\n      baseRecognizer\n        .ensureModelLoaded()\n        .then(() => {\n          tmModelAudio = baseRecognizer.createTransfer(URI);\n          console.log(`@tensorflow/speech-commands Transfer recognizer created (version ${parent.spc.version})`);\n          console.log(\"loading model\", URI);\n          return tmModelAudio.load();\n      })\n      .then(() => tmModelAudio.ensureModelLoaded())\n      .then(() => {\n        console.log(\"loaded model\", tmModelAudio);\n        // Start classifying\n        classifySound(true);\n      })\n      .catch((err) => console.log(err));\n    }\n  } else {\n    if (modelType == 0) {\n      imageClassifier = ml5.imageClassifier(URI + \"model.json\");\n    } else {\n      soundClassifier = ml5.soundClassifier(URI + \"model.json\");\n    }\n  }\n}\n\nfunction classifySound(useLocalModel) {\n  if (!parent || Boolean(parent.isStopCode)) {\n    if (tmModelAudio && tmModelAudio.isListening()) {\n      console.log(\"Stopping sound prediction\");\n      return tmModelAudio.stopListening().then(() => console.log(\"Stopped\"));\n    }\n    return;\n  }\n\n  if (useLocalModel) {\n    console.log(\"Start sound prediction\");\n    let setup = Promise.resolve();\n    if (tmModelAudio && tmModelAudio.isListening()) {\n      setup = tmModelAudio.stopListening();\n    }\n    const ACCURACY = 0.5;\n    setup.then(() => {\n      tmModelAudio.listen(\n        (results) => {\n          const labels = tmModelAudio.wordLabels();\n          let outputs = labels.map((label, idx) => {\n            return {\n              label,\n              confidence: results.scores[idx],\n            };\n          });\n          outputs = outputs.sort((a, b) => b.confidence - a.confidence);\n          console.log(\"Prediction result: \");\n          console.log(outputs);\n          if (!parent || Boolean(parent.isStopCode)) {\n            if (tmModelAudio && tmModelAudio.isListening()) {\n              console.log(\"Stopping prediction\");\n              return tmModelAudio.stopListening().then(() => console.log(\"Stop listen\"));\n            }\n          } else {\n            classifySoundGotResult(null, outputs);\n          }\n        },\n        {\n          overlapFactor: 0.5,\n          probabilityThreshold: ACCURACY,\n        }\n      );\n    })\n    .catch((err) => {\n      console.log(err);\n      classifySoundGotResult(err, undefined);\n    });\n  } else {\n    soundClassifier.classify((err, results) => {\n      if (err) {\n        classifySoundGotResult(err, undefined);\n      } else {\n        classifySoundGotResult(undefined, results);\n      }\n    });\n  }\n}\n\nfunction classifySoundGotResult(error, classifyResults) {\n  if (error) {\n    console.error(error);\n    return;\n  }\n\n  // handle result here\n\n}\n\n\nconst clientId = 'mqttjs_' + Math.random().toString(16).substr(2, 8);\n\nconst host = 'wss://io.adafruit.com:443'\n\nconst options = {clean: true,connectTimeout: 4000,clientId: clientId,username: 'thanhliemtala',password: 'aio_gyUv68VsDq0FC34RFu99SsYdcfEz'}\n\nconst client = mqtt.connect(host, options);\n\nlet p5Speech = new p5.Speech();\n\nlet p5SpeechRec = new p5.SpeechRec(\"en-US\", p5speechRecGotResult);\np5SpeechRec.onEnd = p5speechRecOnEnd;\np5SpeechRec.continuous = false; // do continuous recognition\n\nlet imageClassifier;\n\nlet soundClassifier;\n\nlet tmModelAudio;\n\nfunction preload() {\n  loadAIModel(true, \"\", 1);\n}\n\nfunction setup() {\n  createCanvas(window.parent.document.getElementById('js-runner-container').offsetWidth-50, window.parent.document.getElementById('js-runner-container').offsetHeight-50);\n\n  mqtt_check_connection()\n  p5SpeechRec.start(); // start listening\n\n}\n\nfunction draw() {\n\n}\n\n\nif (false) {\n}\n","name":"voice","extensions":[],"device":"ai"}